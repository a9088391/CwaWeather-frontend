<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AVENGERS WEATHER</title>
    <link rel="icon" type="image/png" href="./icon-v2.png">
    <link rel="apple-touch-icon" href="./icon-v2.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-v2.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --avengers-navy: #0A1628;
            --avengers-blue: #1E3A5F;
            --avengers-steel: #2C3E50;
            --avengers-silver: #BDC3C7;
            --avengers-gold: #D4AF37;
            --avengers-arc: #00D4FF;
            --avengers-white: #ECF0F1;
            --avengers-dark: #0D1B2A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Orbitron', 'Arial', sans-serif;
            background-color: var(--avengers-navy);
            background-size: cover;
            background-position: center top;
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--avengers-white);
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— - ç§‘æŠ€æ„Ÿ */
        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(180deg, rgba(30, 58, 95, 0.95) 0%, rgba(10, 22, 40, 0.95) 100%);
            border-bottom: 2px solid var(--avengers-arc);
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 12px;
            box-shadow: 0 4px 30px rgba(0, 212, 255, 0.2);
        }

        .update-pill {
            font-size: 0.8rem;
            color: var(--avengers-arc);
            background: rgba(0, 212, 255, 0.1);
            padding: 6px 14px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* === ä»Šæ—¥ç„¦é»å¡ç‰‡ - é‹¼éµäººé¢¨æ ¼ === */
        .hero-card {
            background: linear-gradient(145deg, var(--avengers-steel) 0%, var(--avengers-dark) 100%);
            border-radius: 12px;
            padding: 30px 25px;
            padding-top: 40px;
            text-align: center;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.5),
                0 0 30px rgba(0, 212, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            margin-bottom: 25px;
            margin-top: 20px;
            position: relative;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--avengers-arc), var(--avengers-gold), var(--avengers-arc), transparent);
        }

        .hero-card::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: var(--avengers-arc);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--avengers-arc);
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* è‹±é›„æ¨™ç±¤ */
        .hero-period {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, var(--avengers-blue) 0%, var(--avengers-dark) 100%);
            color: var(--avengers-arc);
            padding: 8px 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            border: 1px solid var(--avengers-arc);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            clip-path: polygon(10% 0%, 90% 0%, 100% 50%, 90% 100%, 10% 100%, 0% 50%);
        }

        .hero-temp-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 25px 0;
        }

        .hero-icon {
            font-size: 5rem;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .hero-temp {
            font-size: 4rem;
            font-weight: 900;
            color: var(--avengers-white);
            line-height: 1;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
            font-family: 'Orbitron', sans-serif;
        }

        .hero-desc {
            font-size: 1.3rem;
            color: var(--avengers-silver);
            margin-bottom: 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        /* === å»ºè­°å€ - ç›¾ç‰Œé¢¨æ ¼ === */
        .advice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
        }

        .advice-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%);
            padding: 15px 10px;
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }

        .advice-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: var(--avengers-gold);
        }

        .advice-item:hover {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 0, 0, 0.4) 100%);
            border-color: var(--avengers-arc);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2);
        }

        .advice-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .advice-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--avengers-white);
            margin: 5px 0;
            line-height: 1.2;
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        /* === æœªä¾†é å ± - ç¥ç›¾å±€é¢¨æ ¼ === */
        .section-title {
            font-size: 1.2rem;
            color: var(--avengers-arc);
            margin-bottom: 15px;
            margin-left: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: 'â—†';
            color: var(--avengers-gold);
        }

        .forecast-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 10px;
        }

        .forecast-card {
            background: linear-gradient(145deg, var(--avengers-steel) 0%, var(--avengers-dark) 100%);
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template-columns: 90px 1fr 85px 55px;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .forecast-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--avengers-arc), var(--avengers-gold));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .forecast-card:hover {
            border-color: var(--avengers-arc);
            box-shadow: 0 4px 25px rgba(0, 212, 255, 0.2);
            transform: translateX(5px);
        }

        .forecast-card:hover::before {
            opacity: 1;
        }

        .forecast-date {
            background: linear-gradient(180deg, var(--avengers-blue) 0%, var(--avengers-dark) 100%);
            color: var(--avengers-arc);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
            letter-spacing: 1px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .forecast-weather-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .forecast-icon {
            font-size: 1.6rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .forecast-weather {
            font-size: 0.85rem;
            color: var(--avengers-silver);
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        .forecast-temp {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--avengers-white);
            text-align: center;
            white-space: nowrap;
            font-family: 'Orbitron', sans-serif;
        }

        .forecast-rain {
            font-size: 0.85rem;
            color: var(--avengers-arc);
            font-weight: bold;
            text-align: right;
            white-space: nowrap;
        }

        /* RWD: å°è¢å¹•èª¿æ•´ */
        @media (max-width: 480px) {
            .forecast-card {
                grid-template-columns: 80px 1fr 75px 45px;
                padding: 10px 12px;
                gap: 6px;
            }

            .forecast-date {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .forecast-icon {
                font-size: 1.4rem;
            }

            .forecast-weather {
                font-size: 0.75rem;
            }

            .forecast-temp {
                font-size: 0.8rem;
            }

            .forecast-rain {
                font-size: 0.7rem;
            }
        }

        /* RWD: æ¥µå°è¢å¹• */
        @media (max-width: 360px) {
            .forecast-card {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                padding: 12px 14px;
                gap: 8px;
            }

            .forecast-date {
                font-size: 0.7rem;
                padding: 5px 10px;
                justify-self: start;
            }

            .forecast-rain {
                font-size: 0.8rem;
                justify-self: end;
            }

            .forecast-weather-group {
                grid-column: 1 / 2;
            }

            .forecast-icon {
                font-size: 1.5rem;
            }

            .forecast-weather {
                font-size: 0.8rem;
            }

            .forecast-temp {
                font-size: 0.9rem;
                text-align: right;
                justify-self: end;
            }
        }

        /* === æ¼«å¨é›»å½±é–‹é ­ç¿»æ›¸å‹•ç•« Loading === */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            perspective: 1000px;
        }

        .marvel-intro {
            position: relative;
            width: 280px;
            height: 140px;
        }

        .book-container {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: 900;
            opacity: 0;
            animation: fadePage 3s ease-in-out forwards;
            border-radius: 4px;
        }

        .page-1 {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #00D4FF;
            animation-delay: 0s;
            z-index: 6;
        }
        .page-2 {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: #D4AF37;
            animation-delay: 0.3s;
            z-index: 5;
        }
        .page-3 {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            color: #ECF0F1;
            animation-delay: 0.6s;
            z-index: 4;
        }
        .page-4 {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            color: #00D4FF;
            animation-delay: 0.9s;
            z-index: 3;
        }
        .page-5 {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            color: #D4AF37;
            animation-delay: 1.2s;
            z-index: 2;
        }
        .page-6 {
            background: linear-gradient(135deg, var(--avengers-navy) 0%, var(--avengers-dark) 100%);
            color: var(--avengers-arc);
            animation-delay: 1.5s;
            z-index: 1;
        }

        @keyframes fadePage {
            0%, 16.66% {
                opacity: 1;
            }
            16.67%, 100% {
                opacity: 0;
            }
        }

        .avengers-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--avengers-arc);
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
            letter-spacing: 8px;
            opacity: 0;
            animation: showLogo 0.5s ease-in-out forwards;
            animation-delay: 2.5s;
            font-family: 'Orbitron', sans-serif;
        }

        @keyframes showLogo {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .loading-text {
            color: var(--avengers-silver);
            font-weight: bold;
            margin-top: 40px;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-size: 0.9rem;
            animation: pulse-text 2s infinite;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* ä¸‹æ‹‰é¸å–® - ç§‘æŠ€é¢¨æ ¼ */
        .location-select {
            background: linear-gradient(180deg, var(--avengers-steel) 0%, var(--avengers-dark) 100%);
            color: var(--avengers-arc);
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 1rem;
            border: 1px solid var(--avengers-arc);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            font-family: 'Zen Maru Gothic', sans-serif;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 35px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300D4FF' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            letter-spacing: 1px;
        }

        .location-select:focus {
            border-color: var(--avengers-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .location-select option {
            background: var(--avengers-dark);
            color: var(--avengers-white);
        }

        @media (max-width: 360px) {
            .location-select {
                font-size: 0.9rem;
                padding: 8px 16px;
                padding-right: 30px;
            }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="marvel-intro">
            <div class="book-container">
                <div class="page page-1">ğŸ¦¸</div>
                <div class="page page-2">âš¡</div>
                <div class="page page-3">ğŸ›¡ï¸</div>
                <div class="page page-4">ğŸ”¨</div>
                <div class="page page-5">ğŸ•·ï¸</div>
                <div class="page page-6">ğŸŒ©ï¸</div>
            </div>
            <div class="avengers-logo">A</div>
        </div>
        <p class="loading-text">AVENGERS ASSEMBLE...</p>
    </div>
    <div class="status-bar">
        <select id="locationSelect" class="location-select">
            <option value="å®œè˜­ç¸£">ğŸ“ å®œè˜­ç¸£</option>
            <option value="èŠ±è“®ç¸£">ğŸ“ èŠ±è“®ç¸£</option>
            <option value="è‡ºæ±ç¸£">ğŸ“ è‡ºæ±ç¸£</option>
            <option value="æ¾æ¹–ç¸£">ğŸ“ æ¾æ¹–ç¸£</option>
            <option value="é‡‘é–€ç¸£">ğŸ“ é‡‘é–€ç¸£</option>
            <option value="é€£æ±Ÿç¸£">ğŸ“ é€£æ±Ÿç¸£</option>
            <option value="è‡ºåŒ—å¸‚">ğŸ“ è‡ºåŒ—å¸‚</option>
            <option value="æ–°åŒ—å¸‚">ğŸ“ æ–°åŒ—å¸‚</option>
            <option value="æ¡ƒåœ’å¸‚">ğŸ“ æ¡ƒåœ’å¸‚</option>
            <option value="è‡ºä¸­å¸‚" selected>ğŸ“ è‡ºä¸­å¸‚</option>
            <option value="è‡ºå—å¸‚">ğŸ“ è‡ºå—å¸‚</option>
            <option value="é«˜é›„å¸‚">ğŸ“ é«˜é›„å¸‚</option>
            <option value="åŸºéš†å¸‚">ğŸ“ åŸºéš†å¸‚</option>
            <option value="æ–°ç«¹ç¸£">ğŸ“ æ–°ç«¹ç¸£</option>
            <option value="æ–°ç«¹å¸‚">ğŸ“ æ–°ç«¹å¸‚</option>
            <option value="è‹—æ —ç¸£">ğŸ“ è‹—æ —ç¸£</option>
            <option value="å½°åŒ–ç¸£">ğŸ“ å½°åŒ–ç¸£</option>
            <option value="å—æŠ•ç¸£">ğŸ“ å—æŠ•ç¸£</option>
            <option value="é›²æ—ç¸£">ğŸ“ é›²æ—ç¸£</option>
            <option value="å˜‰ç¾©ç¸£">ğŸ“ å˜‰ç¾©ç¸£</option>
            <option value="å˜‰ç¾©å¸‚">ğŸ“ å˜‰ç¾©å¸‚</option>
            <option value="å±æ±ç¸£">ğŸ“ å±æ±ç¸£</option>
        </select>
        <div id="updateTime" class="update-pill">æ›´æ–°ä¸­...</div>
    </div>

    <div class="container" id="mainContent" style="display: none;">

        <div id="heroCard">
        </div>

        <h3 class="section-title">FUTURE FORECAST</h3>
        <div class="forecast-grid" id="futureForecasts">
        </div>

    </div>

    <script>
        const API_BASE_URL = "https://senna-weather-backend.zeabur.app/api/weather";

        function getApiUrl(locationName) {
            return `${API_BASE_URL}?locationName=${encodeURIComponent(locationName)}`;
        }

        function getWeatherIcon(weather) {
            if (!weather) return "ğŸŒ¤ï¸";
            if (weather.includes("æ™´")) return "â˜€ï¸";
            if (weather.includes("å¤šé›²")) return "â›…";
            if (weather.includes("é™°")) return "â˜ï¸";
            if (weather.includes("é›¨")) return "ğŸŒ§ï¸";
            if (weather.includes("é›·")) return "â›ˆï¸";
            return "ğŸŒ¤ï¸";
        }

        function getAdvice(rainProb, maxTemp) {
            let rainIcon = "ğŸŒ‚";
            let rainText = "ä¸ç”¨å¸¶å‚˜";
            if (parseInt(rainProb) > 30) {
                rainIcon = "â˜‚ï¸";
                rainText = "è¨˜å¾—å¸¶å‚˜ï¼";
            }

            let clothIcon = "ğŸ‘•";
            let clothText = "èˆ’é©ç©¿æ­";
            if (parseInt(maxTemp) >= 28) {
                clothIcon = "ğŸ½";
                clothText = "çŸ­è¢–å‡ºç™¼";
            } else if (parseInt(maxTemp) <= 20) {
                clothIcon = "ğŸ§¥";
                clothText = "åŠ ä»¶å¤–å¥—";
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "æ—©æ™¨";
            if (hour >= 11 && hour < 14) return "ä¸­åˆ";
            if (hour >= 14 && hour < 18) return "ä¸‹åˆ";
            if (hour >= 18 && hour < 23) return "æ™šä¸Š";
            return "æ·±å¤œ";
        }

        function renderWeather(data) {
            const forecasts = data.forecasts;

            // å–å¾—ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const now = new Date();

            // ç”¨ Map ä¾†åˆä½µåŒä¸€å¤©çš„è³‡æ–™
            const daysMap = new Map();
            const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

            // è§£ææº«åº¦å­—ä¸² (ä¾‹å¦‚ "22Â°C" -> 22)
            const parseTemp = (tempStr) => {
                if (!tempStr) return null;
                const match = tempStr.toString().match(/(\d+)/);
                return match ? parseInt(match[1]) : null;
            };

            // å¾ description è§£ææº«åº¦ç¯„åœ (ä¾‹å¦‚ "æº«åº¦æ”æ°15è‡³21åº¦" -> [15, 21])
            const parseTempFromDesc = (desc) => {
                if (!desc) return [];
                const match = desc.match(/æº«åº¦æ”æ°(\d+)è‡³(\d+)åº¦/);
                if (match) {
                    return [parseInt(match[1]), parseInt(match[2])];
                }
                // å–®ä¸€æº«åº¦ "æº«åº¦æ”æ°16åº¦"
                const singleMatch = desc.match(/æº«åº¦æ”æ°(\d+)åº¦/);
                if (singleMatch) {
                    return [parseInt(singleMatch[1])];
                }
                return [];
            };

            // å¾ description è§£æé™é›¨æ©Ÿç‡ (ä¾‹å¦‚ "é™é›¨æ©Ÿç‡20%" -> 20)
            const parseRainFromDesc = (desc) => {
                if (!desc) return null;
                const match = desc.match(/é™é›¨æ©Ÿç‡(\d+)%/);
                return match ? parseInt(match[1]) : null;
            };

            forecasts.forEach(f => {
                const fDate = new Date(f.startTime);
                const fDateOnly = new Date(fDate);
                fDateOnly.setHours(0, 0, 0, 0);
                const diffDays = Math.floor((fDateOnly - today) / (1000 * 60 * 60 * 24));

                // åˆä½µåŒä¸€å¤©çš„è³‡æ–™ (åŒ…å«ä»Šå¤©)
                if (diffDays >= 0) {
                    const dateKey = fDateOnly.toISOString().split('T')[0];

                    // å„ªå…ˆä½¿ç”¨ temperature æ¬„ä½ï¼Œè‹¥ç‚ºç©ºå‰‡å¾ description è§£æ
                    let temps = [];
                    const temp = parseTemp(f.temperature);
                    if (temp !== null) {
                        temps = [temp];
                    } else {
                        temps = parseTempFromDesc(f.description);
                    }

                    // å„ªå…ˆä½¿ç”¨ rain æ¬„ä½ï¼Œè‹¥ç‚ºç©ºå‰‡å¾ description è§£æ
                    let rainValue = null;
                    if (f.rain && f.rain.trim() !== '') {
                        rainValue = parseInt(f.rain) || 0;
                    } else {
                        rainValue = parseRainFromDesc(f.description);
                    }

                    if (!daysMap.has(dateKey)) {
                        daysMap.set(dateKey, {
                            diffDays,
                            fDate: fDateOnly,
                            temps: [],
                            weathers: [],
                            rains: []
                        });
                    }

                    const dayData = daysMap.get(dateKey);
                    temps.forEach(t => dayData.temps.push(t));
                    if (f.weather) dayData.weathers.push(f.weather);
                    if (rainValue !== null) dayData.rains.push(rainValue);
                }
            });

            // å°‡ Map è½‰ç‚ºé™£åˆ—ä¸¦æ’åº
            const allDays = Array.from(daysMap.values()).sort((a, b) => a.diffDays - b.diffDays);

            // å–å¾—ä»Šå¤©çš„è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰ä»Šå¤©è³‡æ–™å‰‡ç”¨ç¬¬ä¸€ç­†è³‡æ–™
            let todayData = allDays.find(d => d.diffDays === 0);
            let heroLabel = "TODAY";

            // å¦‚æœæ²’æœ‰ä»Šå¤©çš„è³‡æ–™ï¼Œä½¿ç”¨æœ€è¿‘ä¸€å¤©çš„è³‡æ–™ä½œç‚ºä¸»å¡ç‰‡
            if (!todayData && allDays.length > 0) {
                todayData = allDays[0];
                // è¨­å®šæ¨™ç±¤ç‚ºæ˜å¤©æˆ–æ—¥æœŸ
                if (todayData.diffDays === 1) {
                    heroLabel = "TOMORROW";
                } else {
                    const month = todayData.fDate.getMonth() + 1;
                    const date = todayData.fDate.getDate();
                    heroLabel = `${month}/${date}`;
                }
            }

            // å–å¾—æ‰€æœ‰æœªä¾†å¤©æ•¸çš„è³‡æ–™ (æ’é™¤å·²ç”¨æ–¼ä¸»å¡ç‰‡çš„é‚£å¤©)
            const futureDays = allDays.filter(d => d !== todayData);

            // è¨ˆç®—çµ±è¨ˆè³‡æ–™çš„å‡½æ•¸
            const getDayStats = (dayData) => {
                const minTemp = dayData.temps.length > 0 ? Math.min(...dayData.temps) : '--';
                const maxTemp = dayData.temps.length > 0 ? Math.max(...dayData.temps) : '--';

                // å–æœ€å¸¸å‡ºç¾çš„å¤©æ°£æè¿°
                const weatherCounts = {};
                dayData.weathers.forEach(w => {
                    weatherCounts[w] = (weatherCounts[w] || 0) + 1;
                });
                const mainWeather = Object.entries(weatherCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'æ™´';

                // å–æœ€é«˜é™é›¨ç‡
                const maxRain = dayData.rains.length > 0 ? Math.max(...dayData.rains) : 0;

                return { minTemp, maxTemp, mainWeather, maxRain };
            };

            // 1. æ¸²æŸ“ Hero Card (ä¸»ç•«é¢ - ä»Šå¤©æˆ–æœ€è¿‘ä¸€å¤©)
            if (todayData) {
                const { minTemp, maxTemp, mainWeather, maxRain } = getDayStats(todayData);
                const advice = getAdvice(maxRain + '%', maxTemp);

                document.getElementById('heroCard').innerHTML = `
                        <div class="hero-card">
                            <div class="hero-period">${heroLabel}</div>
                            <div class="hero-temp-container">
                                <div class="hero-icon">${getWeatherIcon(mainWeather)}</div>
                                <div class="hero-temp">${minTemp} ~ ${maxTemp}Â°</div>
                            </div>
                            <div class="hero-desc">${mainWeather}</div>

                            <div class="advice-grid">
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.rainIcon}</div>
                                    <div class="advice-text">${advice.rainText}</div>
                                    <div style="font-size:0.8rem; color:#00D4FF; font-weight:bold; letter-spacing:1px">é™é›¨ç‡ ${maxRain}%</div>
                                </div>
                                <div class="advice-item">
                                    <div class="advice-icon">${advice.clothIcon}</div>
                                    <div class="advice-text">${advice.clothText}</div>
                                    <div style="font-size:0.8rem; color:#D4AF37; font-weight:bold; letter-spacing:1px">æœ€é«˜æº« ${maxTemp}Â°</div>
                                </div>
                            </div>
                        </div>
                    `;
            }

            // 2. æ¸²æŸ“æœªä¾†å¤©æ°£å¡ç‰‡ (æ¯å¤©ä¸€å¼µå¡ç‰‡)
            const forecastContainer = document.getElementById('futureForecasts');
            forecastContainer.innerHTML = '';

            futureDays.forEach(dayData => {
                const { minTemp, maxTemp, mainWeather, maxRain } = getDayStats(dayData);

                let dateLabel = "";
                if (dayData.diffDays === 1) {
                    dateLabel = "æ˜å¤©";
                } else if (dayData.diffDays === 2) {
                    dateLabel = "å¾Œå¤©";
                } else {
                    const month = dayData.fDate.getMonth() + 1;
                    const date = dayData.fDate.getDate();
                    const dayName = dayNames[dayData.fDate.getDay()];
                    dateLabel = `${month}/${date} ${dayName}`;
                }

                forecastContainer.innerHTML += `
                            <div class="forecast-card">
                                <div class="forecast-date">${dateLabel}</div>
                                <div class="forecast-weather-group">
                                    <div class="forecast-icon">${getWeatherIcon(mainWeather)}</div>
                                    <div class="forecast-weather">${mainWeather}</div>
                                </div>
                                <div class="forecast-temp">${minTemp} ~ ${maxTemp}Â°</div>
                                <div class="forecast-rain">ğŸ’§ ${maxRain}%</div>
                            </div>
                        `;
            });

            // 3. å³é‚Šé¡¯ç¤ºä»Šæ—¥æ—¥æœŸ
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dayIndex = now.getDay();

            document.getElementById('updateTime').textContent = `${month}æœˆ${date}æ—¥ ${dayNames[dayIndex]}`;
        }

        async function fetchWeather(locationName, showLoading = true) {
            try {
                // é¡¯ç¤º Loading (åªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚é¡¯ç¤º)
                if (showLoading) {
                    document.getElementById('loading').style.display = 'flex';
                    document.getElementById('mainContent').style.display = 'none';
                }

                // 1. å®šç¾©ã€Œæœ€ä½ç­‰å¾…æ™‚é–“ã€ï¼š1500 æ¯«ç§’ (1.5ç§’)ï¼Œåªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚ç­‰å¾…
                const delayPromise = showLoading
                    ? new Promise(resolve => setTimeout(resolve, 3500))
                    : Promise.resolve();

                // 2. å®šç¾©ã€ŒæŠ“å–è³‡æ–™ã€çš„å·¥ä½œ
                const apiUrl = getApiUrl(locationName);
                const fetchPromise = fetch(apiUrl).then(res => res.json());

                // 3. Promise.all æœƒç­‰å¾…ã€Œå…©å€‹éƒ½å®Œæˆã€æ‰æœƒå¾€ä¸‹èµ°
                const [_, json] = await Promise.all([delayPromise, fetchPromise]);

                if (json.success) {
                    renderWeather(json.data);

                    // è³‡æ–™è™•ç†å¥½å¾Œï¼Œéš±è— Loadingï¼Œé¡¯ç¤ºä¸»ç•«é¢
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    throw new Error("API Error");
                }
            } catch (e) {
                console.error(e);
                alert("ä»»å‹™å¤±æ•—ï¼šç„¡æ³•å–å¾—æ°£è±¡æ•¸æ“šã€‚æ´›åŸºå¯èƒ½æ­£åœ¨å¹²æ“¾è¨Šè™Ÿ...");
                // å¦‚æœå¤±æ•—ï¼Œè‡³å°‘é¡¯ç¤ºä¸»ç•«é¢
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
        }

        // éš¨æ©ŸèƒŒæ™¯åœ–ç‰‡
        const backgrounds = [
            'https://images.unsplash.com/photo-1612036782180-6f0b6cd846fe?w=1400&q=80', // Avengers
            'https://images.unsplash.com/photo-1569003339405-ea396a5a8a90?w=1400&q=80', // Captain America
            'https://images.unsplash.com/photo-1620336655055-088d06e36bf0?w=1400&q=80', // Thor
            'https://images.unsplash.com/photo-1601645191163-3fc0d5d64e35?w=1400&q=80', // Hulk
            'https://images.unsplash.com/photo-1618519764620-7403abdbdfe9?w=1400&q=80', // Marvel Comics style
            'https://images.unsplash.com/photo-1612036782180-6f0b6cd846fe?w=1400&q=80', // Avengers poster
        ];

        function setRandomBackground() {
            const randomIndex = Math.floor(Math.random() * backgrounds.length);
            const selectedBg = backgrounds[randomIndex];
            document.body.style.backgroundImage = `
                linear-gradient(to bottom, rgba(10, 22, 40, 0.88) 0%, rgba(10, 22, 40, 0.92) 100%),
                url('${selectedBg}')
            `;
        }

        document.addEventListener("DOMContentLoaded", () => {
            // è¨­å®šéš¨æ©ŸèƒŒæ™¯
            setRandomBackground();

            const locationSelect = document.getElementById('locationSelect');

            // åˆå§‹è¼‰å…¥é è¨­ç¸£å¸‚çš„å¤©æ°£
            fetchWeather(locationSelect.value, true);

            // ç›£è½ä¸‹æ‹‰é¸å–®è®Šæ›´äº‹ä»¶
            locationSelect.addEventListener('change', (e) => {
                fetchWeather(e.target.value, false);
            });
        });
    </script>
</body>

</html>